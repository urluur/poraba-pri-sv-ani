<!DOCTYPE html>
<html lang="sl">

<head>
    <meta charset="UTF-8">
    <title>Poroƒçilo meseƒçne porabe</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.9/build/pdfmake.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.9/build/vfs_fonts.js"></script>

    <style>
        body {
            background: #f4f4f4;
        }

        .section-title {
            margin-top: 40px;
            font-weight: 700;
        }

        .drop-zone {
            border: 2px dashed #6c757d;
            padding: 40px;
            background: white;
            text-align: center;
            cursor: pointer;
        }

        .drop-zone.dragover {
            border-color: #0d6efd;
            background: #eef4ff;
        }

        @media print {

            .drop-zone,
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <div class="container my-5" id="reportRoot">

        <h2>POROƒåILO MESEƒåNE PORABE</h2>
        <div class="text-muted mb-3" id="monthLabel"></div>

        <div id="dropZone" class="drop-zone mb-4 no-print">
            Povlecite <b>csvReport_12m_*.csv</b> sem ali kliknite
        </div>
        <input type="file" id="fileInput" hidden>

        <button class="btn btn-primary mb-4 no-print" onclick="exportPDF()">üìÑ Izvozi v PDF</button>

        <!-- ================= ELECTRICITY ================= -->
        <!-- TODO: Make a clear seperation between RG and RSE -->
        <div class="section-title">ODJEMNO MESTO DOM SV. ANA (RG + Rsamostan + Rstud + RZR)</div>

        <div class="row">
            <div class="col-md-8">
                <table class="table table-bordered">
                    <thead class="table-secondary text-center">
                        <tr>
                            <th>Skupina</th>
                            <th>T1 (kWh)</th>
                            <th>T2 (kWh)</th>
                            <th>Skupaj (kWh)</th>
                            <th>Dele≈æ (%)</th>
                            <th>Cena (‚Ç¨)</th>
                        </tr>
                    </thead>
                    <tbody id="elTable"></tbody>
                    <tfoot class="table-light text-center">
                        <tr>
                            <th>SKUPAJ</th>
                            <th id="elT1"></th>
                            <th id="elT2"></th>
                            <th id="elTot"></th>
                            <th>100</th>
                            <th id="elCost"></th>
                        </tr>
                    </tfoot>
                </table>

                <div class="mb-3">
                    Cena elektrike za RG (‚Ç¨/kWh):
                    <input type="number" step="0.001" id="elPrice" value="0.13975" oninput="recalcCosts()">
                </div>
            </div>

            <div class="col-md-4">
                <canvas id="elChart"></canvas>
            </div>
        </div>

        <!-- ================= HEATING ================= -->
        <div class="section-title">OGREVANJE IN HLAJENJE (RG: Toplotna ƒårpalka (Tƒå))</div>

        <div class="row">
            <div class="col-md-8">
                <table class="table table-bordered">
                    <thead class="table-secondary text-center">
                        <tr>
                            <th>Objekt</th>
                            <th>Ogrevanje (MWh)</th>
                            <th>Hladjenje (MWh)</th>
                            <th>Skupaj (MWh)</th>
                            <th>Dele≈æ ogrevanja (%)</th>
                            <th>Cena (‚Ç¨)</th>
                        </tr>
                    </thead>
                    <tbody id="hcTable"></tbody>
                    <tfoot class="table-light text-center">
                        <tr>
                            <th>SKUPAJ</th>
                            <th id="hcHeat"></th>
                            <th id="hcCool"></th>
                            <th id="hcTot"></th>
                            <th>100</th>
                            <th id="hcCost"></th>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="col-md-4">
                <canvas id="hcChart"></canvas>
            </div>
        </div>

        <!-- ================= RSE ================= -->
        <div class="section-title">ODJEMNO MESTO FRANƒåI≈†KANSKI SAMOSTAN KOPER (+RSE)</div>

        <div class="row">
            <div class="col-md-8">
                <table class="table table-bordered">
                    <thead class="table-secondary text-center">
                        <tr>
                            <th>Skupina</th>
                            <th>T1 (kWh)</th>
                            <th>T2 (kWh)</th>
                            <th>Skupaj (kWh)</th>
                            <th>Dele≈æ (%)</th>
                            <th>Cena (‚Ç¨)</th>
                        </tr>
                    </thead>
                    <tbody id="rseTable"></tbody>
                    <tfoot class="table-light text-center">
                        <tr>
                            <th>SKUPAJ</th>
                            <th id="rseT1"></th>
                            <th id="rseT2"></th>
                            <th id="rseTot"></th>
                            <th>100</th>
                            <th id="rseCost"></th>
                        </tr>
                    </tfoot>
                </table>

                <div class="mb-3">
                    Cena elektrike za RSE (‚Ç¨/kWh):
                    <input type="number" step="0.001" id="rsePrice" value="0.17750" oninput="recalcCosts()">
                </div>
            </div>

            <div class="col-md-4">
                <canvas id="rseChart"></canvas>
            </div>
        </div>


        <!-- ================= WATER ================= -->
        <div class="section-title">VODOMERI</div>

        <div class="row">
            <div class="col-md-8">

                <table class="table table-bordered">
                    <thead class="table-secondary text-center">
                        <tr>
                            <th>Objekt</th>
                            <th>Zaƒçetek</th>
                            <th>Konec</th>
                            <th>Poraba (l)</th>
                            <th>Dele≈æ (%)</th>
                            <th>Cena (‚Ç¨)</th>
                        </tr>
                    </thead>
                    <tbody id="waterTable"></tbody>
                    <tfoot class="table-light text-center">
                        <tr>
                            <th>SKUPAJ</th>
                            <th></th>
                            <th></th>
                            <th id="waterTot"></th>
                            <th>100</th>
                            <th id="waterCost"></th>
                        </tr>
                    </tfoot>
                </table>

                <div class="mb-3">
                    Cena vode (‚Ç¨/m¬≥):
                    <input type="number" step="0.01" id="waterPrice" value="2.0" oninput="recalcCosts()">
                </div>
            </div>

            <div class="col-md-4">
                <canvas id="waChart"></canvas>
            </div>
        </div>

        <!-- ================= TOTAL ================= -->
        <div class="section-title">SE≈†TEVEK ZNESKOV (‚Ç¨)</div>
        <h4 id="grandTotal"></h4>

        <div class="mb-3">
            <label>
                <input type="checkbox" id="roundToggle" onchange="recalcCosts()" checked>
                Prika≈æi zaokro≈æene vrednosti
            </label>
        </div>

    </div>

    <script>
        const dz = document.getElementById("dropZone");
        const fi = document.getElementById("fileInput");
        dz.onclick = () => fi.click();
        dz.ondragover = e => { e.preventDefault(); dz.classList.add("dragover") };
        dz.ondragleave = () => dz.classList.remove("dragover");
        dz.ondrop = e => { e.preventDefault(); dz.classList.remove("dragover"); parse(e.dataTransfer.files[0]) };
        fi.onchange = e => parse(e.target.files[0]);

        let EL = [], HC = [], WA = [], RSE = [];

        function num(v) { if (!v || v === "Ni podatka") return 0; return parseFloat(v.replace(",", ".")); }

        function parse(file) {
            Papa.parse(file, {
                header: true, delimiter: ";", skipEmptyLines: true,
                complete: r => build(r.data.reverse().find(x => x["Mesec/Leto"]))
            });
        }

        function parsePercent(value) {
            if (!value || value === "Ni podatka") return 0;
            return parseFloat(value.replace(",", ".")).toFixed(2);
        }

        function build(row) {
            document.getElementById("monthLabel").textContent = "Mesec: " + row["Mesec/Leto"];

            const groups = ["SANITARNE TC IN KLIMAT", "STUDENTSKA PASTORALA", "SAMOSTAN", "TOPLOTNA CRPALKA", "STUDENTSKI DOM", "CICERON"];
            const hcGroups = ["STUDENTSKA PASTORALA", "SAMOSTAN", "GALERIJA", "STUDENTSKI DOM", "CICERON", "ROTUNDA", "CERKEV"];
            const rseGroups = ["SERVER SOBA", "ROTUNDA", "CERKEV"];
            const waterGroups = ["SAMOSTAN", "STUDENTSKI DOM", "STUDENTSKA PASTORALA", "ROTUNDA"];
            EL = [];
            HC = [];
            WA = [];
            RSE = [];

            let t1 = 0, t2 = 0, tt = 0;
            elTable.innerHTML = "";

            groups.forEach(g => {
                const a = num(row[`${g} - El. en. T1 (kWh)`]);
                const b = num(row[`${g} - El. en. T2 (kWh)`]);
                const c = num(row[`${g} - El. en. T1+T2 (kWh)`]);
                const d = parsePercent(row[`${g} - Delez el. en. (%)`] || 0);
                EL.push({ g, a, b, c, d });
                t1 += a;
                t2 += b;
                tt += c;
                elTable.innerHTML += `
                    <tr class="text-center">
                        <td class="text-start">${g}</td>
                        <td>${a}</td>
                        <td>${b}</td>
                        <td>${c}</td>
                        <td>${d}</td>
                        <td class="elCost"></td>
                    </tr>`;
            });
            elT1.textContent = t1;
            elT2.textContent = t2;
            elTot.textContent = tt;

            let hs = 0, cs = 0, ts = 0;
            hcTable.innerHTML = "";
            hcGroups.forEach(o => {
                console.log(`Processing heating and cooling for: ${o}`);

                const hStart = num(row[`${o} - Ogr. stevec zac. mes. (MWh)`]);
                const hEnd = num(row[`${o} - Ogr. stevec kon. mes. (MWh)`]);
                const h = num(row[`${o} - Ogr. en. (MWh)`]); // heating
                const cStart = num(row[`${o} - Hlad. stevec zac. mes. (MWh)`]);
                const cEnd = num(row[`${o} - Hlad. stevec kon. mes. (MWh)`]);
                const c = num(row[`${o} - Hlad. en. (MWh)`]); // cooling
                const s = h + c; // sum

                console.log(
                    `Heating: ${hStart} -> ${hEnd} = ${h}, Cooling: ${cStart} -> ${cEnd} = ${c}, Total: ${s}`
                );

                HC.push({ o, h, c, s });
                hs += h;
                cs += c;
                ts += s;
                hcTable.innerHTML += `
                    <tr class="text-center">
                        <td class="text-start">${o}</td>
                        <td>${h}</td><td>${c}</td>
                        <td>${s}</td>
                        <td class="hcPercentage"></td>
                        <td class="hcCost"></td>
                    </tr>`;
            });
            hcHeat.textContent = hs;
            hcCool.textContent = cs;
            hcTot.textContent = ts;

            // parse RSE
            let rseT1 = 0, rseT2 = 0, rseTot = 0;
            rseTable.innerHTML = "";
            rseGroups.forEach(g => {
                const a = num(row[`${g} - El. en. T1 (kWh)`]);
                const b = num(row[`${g} - El. en. T2 (kWh)`]);
                const c = num(row[`${g} - El. en. T1+T2 (kWh)`]);
                const d = parsePercent(row[`${g} - Delez el. en. (%)`] || 0);
                RSE.push({ g, a, b, c, d });
                rseT1 += a;
                rseT2 += b;
                rseTot += c;
                rseTable.innerHTML += `
                    <tr class="text-center">
                        <td class="text-start">${g}</td>
                        <td>${a}</td>
                        <td>${b}</td>
                        <td>${c}</td>
                        <td>${d}</td>
                        <td class="rseCost"></td>
                    </tr>`;
            });
            document.getElementById("rseT1").textContent = rseT1.toFixed(2);
            document.getElementById("rseT2").textContent = rseT2.toFixed(2);
            document.getElementById("rseTot").textContent = rseTot.toFixed(2);

            // parse WATER
            let ws = 0;
            waterTable.innerHTML = "";
            waterGroups.forEach(o => {
                console.log(`Processing water meter data for: ${o}`);

                const start = num(row[`${o} - Vodomer stevec zac. mes. (l)`]);
                const end = num(row[`${o} - Vodomer stevec kon. mes. (l)`]);
                const consumption = num(row[`${o} - Poraba vode (l)`]);

                ws += consumption;

                WA.push({ o, start, end, consumption });
                waterTable.innerHTML += `
                    <tr class="text-center">
                        <td class="text-start">${o}</td>
                        <td>${start}</td>
                        <td>${end}</td>
                        <td>${consumption}</td>
                        <td class="waPercentage"></td>
                        <td class="waCost"></td>
                    </tr>`;
            });

            document.querySelectorAll(".waPercentage").forEach((cell, i) => {
                const percentage = (WA[i].consumption / ws) * 100 || 0;
                cell.textContent = percentage.toFixed(2);
            });

            waterTot.textContent = ws;

            drawChart();
            recalcCosts();
        }

        function drawChart() {
            // RG chart
            new Chart(elChart, {
                type: "pie",
                data: {
                    labels: EL.map(x => x.g),
                    datasets: [{ data: EL.map(x => x.d) }]
                }
            });

            // Heating and cooling chart
            new Chart(hcChart, {
                type: "pie",
                data: {
                    labels: HC.map(x => x.o),
                    datasets: [{ data: HC.map(x => x.s) }]
                }
            });

            // RSE chart
            new Chart(rseChart, {
                type: "pie",
                data: {
                    labels: RSE.map(x => x.g),
                    datasets: [{ data: RSE.map(x => x.d) }]
                }
            });

            // Water chart
            new Chart(waChart, {
                type: "pie",
                data: {
                    labels: WA.map(x => x.o),
                    datasets: [{ data: WA.map(x => x.consumption) }]
                }
            });
        }

        function recalcCosts() {
            let elP = parseFloat(elPrice.value) || 0;
            let waP = parseFloat(waterPrice.value) || 0;
            let rseP = parseFloat(rsePrice.value) || 0;

            let elSum = 0, hcSum = 0, waSum = 0, rseSum = 0;

            const roundValues = document.getElementById("roundToggle").checked; // is rounding enabled?

            // electricity costs
            let t2Sum = 0;
            document.querySelectorAll(".elCost").forEach((c, i) => {
                let v = EL[i].c * elP;
                elSum += v;
                t2Sum += EL[i].b;
                c.textContent = roundValues ? v.toFixed(2) : v;
            });
            elCost.textContent = roundValues ? elSum.toFixed(2) : elSum;
            elT2.textContent = roundValues ? t2Sum.toFixed(2) : t2Sum;

            // heating costs
            const totalHeatingEnergy = HC.reduce((sum, loc) => sum + loc.s, 0);
            const toplotnaCrpalkaCost = EL.find(x => x.g === "TOPLOTNA CRPALKA").c * elP;
            let totalPercentage = 0;
            let ogrSum = 0;

            document.querySelectorAll(".hcCost").forEach((c, i) => {
                let percentage = (HC[i].s / totalHeatingEnergy) * 100;
                totalPercentage += percentage;

                let v = toplotnaCrpalkaCost * (HC[i].s / totalHeatingEnergy);
                hcSum += v;
                ogrSum += HC[i].h;


                c.parentElement.querySelector(".hcPercentage").textContent = roundValues ? percentage.toFixed(2) : percentage;

                c.textContent = roundValues ? v.toFixed(2) : v;
            });

            hcCost.textContent = roundValues ? hcSum.toFixed(2) : hcSum;
            hcHeat.textContent = roundValues ? ogrSum.toFixed(2) : ogrSum;


            document.querySelectorAll(".waCost").forEach((c, i) => {
                let v = (WA[i].consumption / 1000) * waP;
                waSum += v;
                c.textContent = roundValues ? v.toFixed(2) : v;
            });
            waterCost.textContent = roundValues ? waSum.toFixed(2) : waSum;


            document.querySelectorAll(".rseCost").forEach((c, i) => {
                let v = RSE[i].c * rseP;
                rseSum += v;
                c.textContent = roundValues ? v.toFixed(2) : v;
            });
            rseCost.textContent = roundValues ? rseSum.toFixed(2) : rseSum;

            const grandTotalValue = elSum + hcSum + waSum + rseSum;
            grandTotal.textContent = (roundValues ? grandTotalValue.toFixed(2) : grandTotalValue) + " ‚Ç¨";
        }

        function tableToPdfMake(tableEl) {
            const rows = [];
            const pushRow = (tr) => {
                const cells = Array.from(tr.children).map(td => ({
                    text: td.textContent.trim(),
                    alignment: td.classList.contains("text-center") ? "center" : "left"
                }));
                rows.push(cells);
            };

            tableEl.querySelectorAll("thead tr").forEach(pushRow);
            tableEl.querySelectorAll("tbody tr").forEach(pushRow);
            tableEl.querySelectorAll("tfoot tr").forEach(pushRow);

            return {
                unbreakable: true,
                table: {
                    headerRows: tableEl.querySelectorAll("thead tr").length,
                    widths: Array(rows[0]?.length || 1).fill("*"),
                    body: rows,
                    dontBreakRows: true
                },
                layout: "lightHorizontalLines"
            };
        }

        function exportPDF() {
            const sections = [
                { title: "ODJEMNO MESTO DOM SV. ANA (RG + Rsamostan + Rstud + RZR)", tableId: "elTable" },
                { title: "OGREVANJE IN HLAJENJE (RG: Toplotna ƒårpalka)", tableId: "hcTable" },
                { title: "ODJEMNO MESTO FRANƒåI≈†KANSKI SAMOSTAN KOPER (+RSE)", tableId: "rseTable" },
                { title: "VODOMERI", tableId: "waterTable" }
            ];

            const content = [
                { text: "POROƒåILO MESEƒåNE PORABE", style: "header" },
                { text: document.getElementById("monthLabel").textContent, style: "subheader" },
                { text: `Cena elektrike RG (‚Ç¨/kWh): ${elPrice.value}`, style: "subheader" },
                { text: `Cena elektrike RSE (‚Ç¨/kWh): ${rsePrice.value}`, style: "subheader" },
                { text: `Cena vode (‚Ç¨/m¬≥): ${waterPrice.value}`, style: "subheader" }
            ];

            sections.forEach(s => {
                const tableEl = document.getElementById(s.tableId).closest("table");
                content.push({
                    unbreakable: true,
                    stack: [
                        { text: s.title, style: "section" },
                        tableToPdfMake(tableEl)
                    ]
                });
            });

            content.push({ text: `SE≈†TEVEK ZNESKOV: ${grandTotal.textContent}`, style: "total" });

            const docDefinition = {
                pageSize: "A4",
                pageOrientation: "portrait",
                pageMargins: [30, 40, 30, 40],
                content,
                styles: {
                    header: { fontSize: 16, bold: true, margin: [0, 0, 0, 8] },
                    subheader: { fontSize: 10, color: "#666", margin: [0, 0, 0, 12] },
                    section: { fontSize: 12, bold: true, margin: [0, 12, 0, 6] },
                    total: { fontSize: 12, bold: true, margin: [0, 12, 0, 0] }
                }
            };

            pdfMake.createPdf(docDefinition).download("porocilo.pdf");
        }
    </script>
</body>

</html>